(()=>{var m=class{constructor(t,n,o,c){this.how=t;this.where=n;this.reducer=o;this.guard=c}},l=class{constructor(t,n,o,c,I){this.how=t;this.guard=n;this.where=o;this.error=c;this.reducer=I}},p=class{constructor(t,n){this.id=t;this.transitions=n}},y=class{constructor(t,n){this.states=t;this.makeCtx=n}},h=class{constructor(t){this.service=t}get current(){return this.service.machine.states.find(n=>n.id===this.service.state)||this.service.machine.states[0]}},b=class{constructor(t,n,o=i=>{},c=i=>{},I){this.state=t;this.machine=n;this.onStateChange=o;this.onContextChange=c;this.makeCtx=I;this.states=new h(this),this.context=this.resetContext()}resetContext(){return this.makeCtx?this.makeCtx():this.machine.makeCtx()}setState(t){this.state=t,this.onStateChange(this.states.current)}setContext(t){this.context=t,this.onContextChange(this.context)}send(t,n={}){let o=this.states.current.transitions.find(c=>c.how===t);if(o){let c={payload:n,type:o.how};if(o.guard&&!o.guard.fn(this.context,c)){if(!o?.error)return;this.setState(o.error)}else this.setState(o.where);if(o.reducer){let I=o.reducer.fn(this.context,c);this.setContext(o.reducer.fn(this.context,c))}}}};function f(e,t){return new y(e,t)}function x(e,...t){return new p(e,t)}function C(e){return{fn:e}}function d(e){return{fn:e}}function u(e,t,n,o){return new m(e,t,n,o)}function g(e,t,n,o,c){return new l(e,t,n,o,c)}function M(e,t,n,o,c){let I=o||e.states[0].id;return new b(I,e,t,n,c)}var r;(function(o){o[o.LOGIN_SCREEN=0]="LOGIN_SCREEN",o[o.HUB_SCREEN=1]="HUB_SCREEN",o[o.GAME_SCREEN=2]="GAME_SCREEN"})(r||(r={}));var a;(function(i){i[i.LOGIN=0]="LOGIN",i[i.LOGOUT=1]="LOGOUT",i[i.JOIN=2]="JOIN",i[i.PLAY=3]="PLAY",i[i.LEAVE=4]="LEAVE",i[i.END_GAME=5]="END_GAME"})(a||(a={}));var w=()=>({pseudo:"",room:"",life:0,x:0,y:0}),P=(e,t)=>e?.pseudo!==t?.payload?.pseudo,A=e=>e?.life===0,L=(e,t)=>({...e,pseudo:t?.payload?.pseudo??""}),G=e=>({...e,life:3,x:10,y:10}),R=e=>({...e,life:0,x:0,y:0,room:""}),S=(e,t)=>({...e,life:t?.payload?.life,x:t?.payload?.x,y:t?.payload?.y}),v=f([x(r.LOGIN_SCREEN,g(a.LOGIN,d(P),r.HUB_SCREEN,r.LOGIN_SCREEN,C(L))),x(r.HUB_SCREEN,u(a.LOGOUT,r.LOGIN_SCREEN,C(w)),u(a.JOIN,r.GAME_SCREEN,C(G))),x(r.GAME_SCREEN,u(a.LEAVE,r.HUB_SCREEN,C(R)),u(a.PLAY,r.GAME_SCREEN,C(S)),u(a.END_GAME,r.GAME_SCREEN,C(G),d(A)))],w);var s=async e=>new Promise(t=>{globalThis.setTimeout(()=>(console.log("---------------------------"),t(null)),e)}),E=async()=>{let n=M(v,o=>{console.log("on state change : ",o)},o=>{console.log("on ctx change : ",o)});for(console.log("service just create : ",n),await s(500),n.send(a.LOGIN,{pseudo:"truc"}),await s(500),console.log("event login send",n),await s(500),n.send(a.JOIN),await s(500),console.log("event join send",n);n.context.life>0;)await s(500),n.send(a.PLAY,{life:n.context.life-1,x:n.context.x+1,y:n.context.y-1}),await s(500),console.log("event play send",n);await s(500),n.send(a.END_GAME),await s(500),console.log("event endgame send",n),await s(500),n.send(a.LEAVE),await s(500),console.log("event leave send",n),await s(500),n.send(a.LOGOUT),await s(500),console.log("event logout send",n),await s(500)};document.addEventListener("readystatechange",()=>{(window.addEventListener?window:document).addEventListener("load",E,!1)});})();
